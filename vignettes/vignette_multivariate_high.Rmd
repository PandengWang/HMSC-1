---
title:  |
  | HMSC-R 3.0: Getting started with HMSC-R: high-dimensional multivariate models
author: "Gleb Tikhonov, Oystein H. Opedal, Nerea Abrego, Aleksi Lehikoinen & Otso Ovaskainen"
date: "11 March 2019"
output:
   
  pdf_document: default
  word_document: default
  html_document: default
---

# Introduction
The Hierarchical Modelling of Species Communities (HMSC) framework is a statistical framework for analysis of multivariate data, typically from species communities. We assume that the reader has already gone through the vignettes "HMSC-R 3.0: Getting started with HMSC-R: univariate models" and "HMSC-R 3.0: Getting started with HMSC-R: low-dimensional multivariate models". Here we continue with high-dimensional multivariate models, i.e. models for species rich communities consisting of many species.

The main difference between the low- and high-dimensional cases is that only the latter one truly benefits from the hierarchical structure of HMSC. By the hierarchical structure we refer to the species responses to enviromental covariates ($\beta$) being modelled as a function of species traits and phylogenetic relationships. In this context, one species can be considered as one data point. Thus, if there are only a handfull of species, there are no sufficient data to model the influence of traits and phylogenies. In contrast, if there are many (say, several tens) of species, accounting for traits and phylogenies becomes meaningfull.

To get HMSC in use, you need to first install it [https://github.com/hmsc-r/HMSC] and then load it.

```{r message = F}
library(Hmsc)
library(corrplot)
set.seed(8)
```

We also loaded the library corrplot as we will make plots with that, and we set the random number seed to make the results presented here reproducible. This time we did not choose `set.seed(1)` but instead `set.seed(8)` as that results in a simulated phylogeny that fits better our purpose.

# Generating simulated data for a large species community

## Simulating phylogeny and species traits
As an example, we will consider a community consisting of 100 species. To bring an evolutionary perspective to our data and analyses, we start by simulating a phylogeny showing how these species have evolved from their common ancestor. This can be done using the `rcoal` function of the `ape` package.

```{r}
ns = 100
phy = rcoal(n=ns, tip.label = NULL, br = "coalescent")
plot(phy, show.tip.label = FALSE)
```

We will next generate four simulated traits for each of the 100 species. For the sake of illustration will call these traits as *resource use specialization* (trait 1, to be abbreviated as S),*thermal optimum* (trait 2,  to be abbreviated as T), *fecundity* (trait 3,  to be abbreviate as F) and *body size* (trait 4,  to be abbreviate as B).

We assume that traits 1-3 are phylogenetically constrained so that they have evolved according to the diffusion model of trait evoluation. We further assume that traits 2 and 3 are positively correlated with each other so that species with high thermal optimum tend to have high fecundity. These assumptions can be implemented by randomizing the traits from a multivariate normal distribution where the variance-covariance matrix is a Kronecker product between the phylogenetic correlation matrix `C` and a trait-to-trait variance-covariance matrix `V`. The phylogenetic correlation matrix `C` can be generated from the phylogenetic tree using the function `vcv`of the `ape` package.

```{r}
C = vcv(phy, model = "Brownian", corr = TRUE)
V = diag(3)
V[[1]] = 1
V[[2,3]] = V[[3,2]] = 0.9
set.seed(1)
traits = matrix(mvrnorm(n = 1, mu = rep(0,3*ns), Sigma=kronecker(V,C)), ncol = 3)
traits = scale(traits)
for (i in 1:3){
   ma = max(traits[,i])
   mi = min(traits[,i])
   traits[,i] = 2*(traits[,i]-mi)/(ma-mi)-1
}
```

Above, we have re-set the random number seed to generate trait values that fit to our purpose. After randomizing the values of the traits from a multivariate normal distribution, we have scaled them so that -1 is the smallest and +1 is the largest value for each trait.

We assume that body size is independent of the phylogeny. This may be the case for example if there is strong selection on body size, if the species-specific trait optimuma for body size are unrelated to the locations of the species in the phylogeny, and if the genetic architecture underlying body size allows for its rapid evolution in the species group we are considering. Thus, we simply randomize body sizes independently from the phylogeny or the the other traits. To include in our analyses both continuous and categorical traits, we assume that body size is classified to three classes: small (-1), intermediate (0) and large (+1).

```{r}
traits=cbind(traits,rnorm(n=ns))
tmp = traits[,4]
traits[,4] = 0
traits[tmp>0.6,4] = 1
traits[tmp<(-0.6),4] = -1
colnames(traits) = c("specialization","thermal.optimum","fecundity","body.size")
```

We next visualize the trait distributions by plotting them next to the phylogenetic tree.

```{r}
par(fig = c(0,0.6,0,0.8), mar=c(6,0,2,0))
plot(phy, show.tip.label = FALSE)
par(fig = c(0.6,0.9,0.025,0.775), mar=c(6,0,2,0), new=T)
plot.new()
image.plot(t(traits),axes=FALSE,legend.width = 3,legend.shrink=1,
           col = colorRampPalette(c("blue","white","red"))(200))
text(x=0.83,y=0.72,srt = 90,  "S", cex=0.9, pos = 4)
text(x=0.93,y=0.72,srt = 90,  "T", cex=0.9, pos = 4)
text(x=1.03,y=0.72,srt = 90,  "F", cex=0.9, pos = 4)
text(x=1.13,y=0.72,srt = 90,  "B", cex=0.9, pos = 4)
```

As expected, the traits 1-3 (S, T and F) show a clear phylogenetic signal, i.e. related species show similar trait values. Additionally, traits T and F are positively correlated to each other. Traits S may appear to be correlated with the traits T and F, as e.g. the lower part of the graph includes a large number of species that have simultaneously a high value for S and a low value for T and F. However, this apparent correlation is generated simply because also the trait S is phylogenetically constrained. Beyond that, by our assumptions it is independent of the traits T and F. In line with our assumptions, the figure suggests that variation in trait 4 (B) is independent of the phylogeny and of the other traits.

As the next step, we simulate the species data. We will assume 

We consider the landscape shown in Fig. X.1.1, which consists of two kinds of resource patches: those with open habitat resources (e.g. dung produced by herbivores dwelling in open habitats), and those with forest habitat resources (e.g. dung produced by herbivores dwelling in forest habitats). This landscape is inhabited with a community of n_s=100 species. While the species are virtual and our model is a caricature of any real community, the reader may visualize the species being e.g. dung beetles that compete for shared resources. We assume that the species have evolved from a single ancestral species, according to the (randomly generated) phylogenetic tree shown in Fig. X.1.2.
We characterize each species j with its specialization level s_j to forest habitats, relative to open habitats. With S_j>0, the species is better adapted in utilizing forest habitat resources than open habitat resources, whereas S_j<0, the species is better adapted in utilizing open habitat resources than forest habitat resources. If S_j=0, the species is a complete generalist in the sense that it is equally adapted to utilize both forest and open habitat resources. We assume that the specialization level has evolved according to the diffusion model for trait evolution, and thus shows a high phylogenetic signal, as illustrated in Fig. X.1.2.
To create further another dimension of environmental heterogeneity, we assume that the study area involves a climatic gradient, with northern areas having harsher climate than southern areas (Fig. 2.2.1). We assume a trade-off between fecundity and tolerance to harsh conditions, so that species with a lower thermal optimum (denoted by the trait T_j) have a lower fecundity (denoted by the trait F_j), as illustrated in Fig. X.1.2. As with the specialization level S, we assume that also thermal optimum T and fecundity F have evolved according to a diffusion model of evolution, and those they also show a high phylogenetic signal, as illustrated in Fig. X.1.2.
In addition to specialization level, we further characterize the species by their body size B_j, which we for simplicity classify to three categories: small, intermediate, and large. We assume that body size influences the competition among the species, so that large bodied species compete for certain types of resources (say, dung of large herbivores), whereas small bodied species compete for other types of resources (say, dung of small herbivores). We assume (arbitrarily) that body sizes are not phylogenetically constrained, and have thus randomly assigned each species a body size, for which reason their distribution lack any correlation with phylogeny (see Fig. X.1.2).
Technically, the model is defined in continuous space and time as a spatiotemporal point-process (Ovaskainen et al. 2014). When generating the landscape of Fig. 2.1.1, we have assumed that the density of both the forest and open habitat patches is ρ=0.5, and thus generated in total 10,000 patches to the landscape of spatial dimension 100 x 100. All resource patches are assumed to be circular with radius λ=1. We assume that each patch produces three types of resource particles (e.g. dung patches): those consumed by small-, intermediate-, and large-bodied species, each with per patch rate of resource production σ=1. We further assume that all resource particles disappear at per-capita rate q=0.1 unless they are consumed by an individual.
The individuals of each species utilize the resource particles for their survival and reproduction. Each individual can be at two states: resource-deprived or resource-satiated. When at the satiated state, the individual changes to the deprived state at rate h=0.25. When at the deprived state, the individual can change to the satiated state by consuming a resource unit from its proximity. This takes place at a rate that depends on the ability of the individual to utilize the habitat type of the patch, i.e. its specialization level to the forest or open habitat, as well as how adapted the individual is to the climatic conditions at its location. Technically, the resource consumption rate is [equation]. Further, as described above, species with different body sizes do not compete for the same resources, and thus resource competition takes place only within body-size classes. A deprived individual may die, which takes place at per-individual rate m. Satiated individuals produce propagules at rate F_j, which disperse so that they are equally likely to be deposited anywhere within distance δ=1 from their mother. The deposited propagules emerge without delay as new offspring individuals that are at the deprived state. Moreover, we assume that every species has immigration of new offspring individuals outside the simulation area occurring at rate I=0.01 per unit area.
X.2. Simulated metacommunity dynamics: the underlying reality

We initiated the metacommunity by locating 1000 individuals of each species randomly to the landscape, and then simulating the dynamics for 1000 time units. As shown in Fig X.2.1, this resulted in most species first decreasing in their abundance, and then increasing in their abundance until reaching a carrying capacity, around which they fluctuate stochastically. Thanks to the background immigration rate, none of the species are completely extinct from the landscape. To gain some intuition on the community, we have illustrated in Fig. X.2.2 some aspects of the final state of the simulation: the distribution of all 1,345,321 individuals that were present, as well as the distributions of three species with contrasting trait values. To further illustrate the data, we have divided the landscape into a 100 x 100 grid consisting of 10,000 sampling locations, each of size 1 x 1. Fig. X.2.3 shows some aspects of the data aggregated to the level of the grid cells: the total number of individuals in each grid cell, species richness (i.e. the number of species in each grid cell), the numbers of individuals for two selected species, as well as community weighted mean traits of the continuous value traits S, T and F, i.e. the mean trait values over all individuals present in the grid cell. We note that the community weighted mean trait values are distributed according to the expectations, with fecundity and thermal optimum decreasing towards north, and forest specialization being high in forest patches and low in open area patches.
X.3. Sampling data: the observed reality  

While with simulated data, we can know the full state of the system at the level of the exact locations of all individuals at all times, with real data we do not have such a luxury. Rather, species data are typically available only from a subset of all possible spatial locations and time points, and instead of counts of all individuals, the data may be of e.g. presence-absence nature. Such data are illustrated in Fig. X.3.1, where we assume that a virtual ecologist has scored the presence-absences of the species in n_y=200 sampling units at two different time points. Further, some of the species may have remained unobserved, even if they were actually present. To simulate observation error, we have assumed that each individual is observed with probability 0.5, so that a species has been scored more likely to be present in a given grid cell if it abundant. While data with observation error (Fig. X.3.2) show generally similar patterns as data without observation error (Fig. X.3.1), we expect observation error to add noise and thus make it more difficult to infer the underlying processes from the data.
In the forthcoming chapters, we will analyze data sampled from the metacommunity simulations statistically with HMSC. By doing so, we wish to answer two big questions. The first question is that of ecological inference: are we able to infer something about the underlying processes from the sampled data? The second question is about prediction: given the sampled data, are we able to predict species occurrences or abundances in locations (or time points) that were not sampled? With the help of the simulated data, we will examine how the answers to these questions depend on the amount and type of the data. As one key aspect, we will assume either the availability of count data, or presence-absence data. As a second key aspect, we will assume that we have access to a single spatial snapshot, or to time-series data collected at multiple time points. As a third key aspect, we will assume either that the data are complete, or that they come with observation error.

